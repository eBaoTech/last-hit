{"version":3,"sources":["../lib/handler/single-flow.ts"],"names":[],"mappings":"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","file":"single-flow.js","sourcesContent":["import fs from 'fs';\nimport jsonfile from 'jsonfile';\nimport { Flow, Step, Story, StartStep, FlowParameters } from 'last-hit-types';\nimport path from 'path';\nimport stream from 'stream';\nimport Environment from '../config/env';\nimport { createReplayer, ReplayEmitter } from '../replayer';\nimport { CallbackEvent } from '../replayer/replay-emitter';\nimport { FlowFile, FlowResult } from '../types';\nimport { generateKeyByObject, getLogger, getProcessId } from '../utils';\n\nconst processId = getProcessId();\n\nexport const mergeFlowInput = (source: Flow, target: Flow): void => {\n\tif (source.params && source.params.length !== 0) {\n\t\ttarget.params = target.params || [];\n\t\tconst existsParamNames = target.params!.reduce((names, param) => {\n\t\t\tnames[param.name] = true;\n\t\t\treturn names;\n\t\t}, {} as { [key in string]: true });\n\t\tsource.params\n\t\t\t.filter(param => param.type !== 'out')\n\t\t\t.filter(param => existsParamNames[param.name] !== true)\n\t\t\t.forEach(param => target.params!.push(param));\n\t}\n};\n/**\n * find all force dependencies, and merge steps to one flow\n */\nconst findAndMergeForceDependencyFlows = (flow: Flow, env: Environment): Flow => {\n\tconst forceDependencyFlow = {\n\t\tname: flow.name,\n\t\tdescription: `Merged force dependency flows`,\n\t\tsteps: [] as Array<Step>,\n\t\tparams: [] as FlowParameters\n\t};\n\n\tlet currentFlow = flow;\n\twhile (currentFlow.settings && currentFlow.settings.forceDepends) {\n\t\tconst { story: storyName, flow: flowName } = currentFlow.settings.forceDepends;\n\t\tconst dependsFlowFilename = path.join(\n\t\t\tenv.getWorkspace(),\n\t\t\tstoryName,\n\t\t\t`${flowName}.flow.json`\n\t\t);\n\t\tif (!fs.existsSync(dependsFlowFilename) || !fs.statSync(dependsFlowFilename).isFile()) {\n\t\t\tthrow new Error(`Dependency flow[${flowName}@${storyName}] not found.`);\n\t\t}\n\t\tconst dependsFlow: Flow = jsonfile.readFileSync(dependsFlowFilename);\n\n\t\tconst steps = dependsFlow.steps || [];\n\n\t\tforceDependencyFlow.steps.splice(\n\t\t\t0,\n\t\t\t0,\n\t\t\t...steps.map(\n\t\t\t\tstep =>\n\t\t\t\t\t({\n\t\t\t\t\t\t...step,\n\t\t\t\t\t\torigin: {\n\t\t\t\t\t\t\tstory: storyName,\n\t\t\t\t\t\t\tflow: dependsFlow.name,\n\t\t\t\t\t\t\tstepIndex: step.stepIndex\n\t\t\t\t\t\t}\n\t\t\t\t\t} as Step)\n\t\t\t)\n\t\t);\n\t\tmergeFlowInput(dependsFlow, forceDependencyFlow);\n\t\tcurrentFlow = dependsFlow;\n\t}\n\n\tforceDependencyFlow.steps = forceDependencyFlow.steps.filter((step, index) => {\n\t\treturn index === 0 || (step.type !== 'start' && step.type !== 'end');\n\t});\n\tforceDependencyFlow.steps.push({ type: 'end' } as Step);\n\tforceDependencyFlow.steps.forEach((step, index) => (step.stepIndex = index));\n\n\treturn forceDependencyFlow;\n};\n\nconst findInDependencyChain = (\n\tstory: string,\n\tflow: string,\n\tdependsChain: { story: string; flow: string }[]\n) => {\n\treturn dependsChain.some(node => node.story === story && node.flow === flow);\n};\n\nconst doLoopCheck = (\n\tdependsStoryName: string,\n\tdependsFlowName: string,\n\tdependsChain: { story: string; flow: string }[],\n\tenv: Environment\n): boolean => {\n\tif (findInDependencyChain(dependsStoryName, dependsFlowName, dependsChain)) {\n\t\tdependsChain.push({ story: dependsStoryName, flow: dependsFlowName });\n\t\tconst chain = dependsChain.map(({ story, flow }) => `${flow}@${story}`).join(' -> ');\n\t\tthrow new Error(`Loop dependency[${chain}] found.`);\n\t}\n\n\tconst dependsStoryFolder = path.join(env.getWorkspace(), dependsStoryName);\n\tif (!fs.existsSync(dependsStoryFolder) || !fs.statSync(dependsStoryFolder).isDirectory()) {\n\t\tthrow new Error(`Dependency story[${dependsStoryName}] not found.`);\n\t}\n\tconst dependsFlowFilename = path.join(dependsStoryFolder, `${dependsFlowName}.flow.json`);\n\tif (!fs.existsSync(dependsFlowFilename) || !fs.statSync(dependsFlowFilename).isFile()) {\n\t\tthrow new Error(`Dependency flow[${dependsFlowName}@${dependsStoryName}] not found.`);\n\t}\n\n\tconst dependsFlow = jsonfile.readFileSync(dependsFlowFilename);\n\tconst { forceDepends = null } = dependsFlow.settings || {};\n\tif (forceDepends) {\n\t\tif (findInDependencyChain(forceDepends.story, forceDepends.flow, dependsChain)) {\n\t\t\tdependsChain.push({ story: dependsStoryName, flow: dependsFlowName });\n\t\t\tconst chain = dependsChain.map(({ story, flow }) => `${flow}@${story}`).join(' -> ');\n\t\t\tthrow new Error(`Loop dependency[${chain}] found.`);\n\t\t} else {\n\t\t\t// push dependency to chain\n\t\t\tdependsChain.push({ story: dependsStoryName, flow: dependsFlowName });\n\t\t\treturn doLoopCheck(forceDepends.story, forceDepends.flow, dependsChain, env);\n\t\t}\n\t}\n\treturn true;\n};\n\n/**\n * only check loop. return true even dependency flow not found.\n */\nconst loopCheck = (\n\tdependsStoryName: string,\n\tdependsFlowName: string,\n\tmyStoryName: string,\n\tmyFlowName: string,\n\tenv: Environment\n): boolean => {\n\treturn doLoopCheck(\n\t\tdependsStoryName,\n\t\tdependsFlowName,\n\t\t[{ story: myStoryName, flow: myFlowName }],\n\t\tenv\n\t);\n};\n\nconst replayNextStep = (\n\temitter: ReplayEmitter,\n\tstory: Story,\n\tflow: Flow,\n\tindex: number,\n\tresolve: () => void\n) => {\n\thandleReplayStepEnd(emitter, story, flow, resolve);\n\temitter.send(`continue-replay-step-${generateKeyByObject(story, flow)}`, {\n\t\tstoryName: story.name,\n\t\tflow,\n\t\tindex: index + 1\n\t});\n};\n\nconst handleReplayStepEnd = (\n\temitter: ReplayEmitter,\n\tstory: Story,\n\tflow: Flow,\n\tresolve: () => void\n): void => {\n\tconst key = generateKeyByObject(story, flow);\n\temitter.once(\n\t\t`replay-step-end-${key}`,\n\t\t(event: CallbackEvent, arg: { error?: any; index: number }): void => {\n\t\t\tconst { error, index } = arg;\n\t\t\tif (error) {\n\t\t\t\t(async () => {\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t(`Process[${processId}] Replay flow ${key} failed on step ${index}.`\n\t\t\t\t\t\t\t.bold as any).red,\n\t\t\t\t\t\terror\n\t\t\t\t\t);\n\t\t\t\t\temitter.once(`replay-browser-abolish-${key}`, () => resolve());\n\t\t\t\t\t// abolish anyway\n\t\t\t\t\temitter.send(`continue-replay-step-${key}`, { command: 'abolish' });\n\t\t\t\t})();\n\t\t\t} else if (flow.steps![index].type === 'end' || index >= flow.steps!.length - 1) {\n\t\t\t\t// the end or last step is finished\n\t\t\t\t(async () => {\n\t\t\t\t\tconsole.info(\n\t\t\t\t\t\t(`Process[${processId}] Replay flow ${key} finished.`.bold as any).green\n\t\t\t\t\t);\n\t\t\t\t\temitter.once(`replay-browser-abolish-${key}`, () => resolve());\n\t\t\t\t\temitter.send(`continue-replay-step-${key}`, { command: 'abolish' });\n\t\t\t\t})();\n\t\t\t} else {\n\t\t\t\t// go on\n\t\t\t\treplayNextStep(emitter, story, flow, index, resolve);\n\t\t\t}\n\t\t}\n\t);\n};\n\nexport const handleFlow = (flowFile: FlowFile, env: Environment): Promise<FlowResult> => {\n\tconst logger = getLogger();\n\tconst { story: storyName, flow: flowName } = flowFile;\n\tconst flowKey = `${flowName}@${storyName}`;\n\tconst workspace = env.getWorkspace();\n\n\tconst timeLoggerStream = new stream.Transform();\n\tlet timeSpent;\n\ttimeLoggerStream._transform = function(chunk, encoding, done) {\n\t\tthis.push(chunk);\n\t\ttimeSpent = typeof chunk === 'string' ? chunk : chunk.toString();\n\t\tdone();\n\t};\n\tconst timeLogger = new console.Console({ stdout: timeLoggerStream });\n\ttimeLogger.time(flowKey);\n\n\tconsole.info(\n\t\t(`Process[${processId}] Start to replay [${flowKey}].` as any).italic.blue.underline\n\t);\n\tconst file = path.join(workspace, storyName, `${flowName}.flow.json`);\n\tlet flow: Flow;\n\ttry {\n\t\tflow = jsonfile.readFileSync(file);\n\t} catch (e) {\n\t\tlogger.error(e);\n\t\treturn Promise.reject();\n\t}\n\tflow.name = flowName;\n\n\tif (flow.steps == null || flow.steps.length === 0) {\n\t\tconsole.info((`Process[${processId}] Flow ${flowKey} has no steps, ignored.` as any).red);\n\t\treturn Promise.reject();\n\t}\n\n\tif (flow.settings && flow.settings.forceDepends) {\n\t\t// has force dependency\n\t\tconst { story: dependsStoryName, flow: dependsFlowName } = flow.settings.forceDepends;\n\t\ttry {\n\t\t\tloopCheck(dependsStoryName, dependsFlowName, storyName, flowName, env);\n\t\t} catch (e) {\n\t\t\tlogger.error(e);\n\t\t\tconsole.info(\n\t\t\t\t(`Process[${processId}] Flow ${flowKey} failed on force dependency loop check, ignored.` as any)\n\t\t\t\t\t.red\n\t\t\t);\n\t\t\treturn Promise.reject();\n\t\t}\n\t\tconst forceDependsFlow = findAndMergeForceDependencyFlows(flow, env);\n\t\t// remove end step\n\t\tforceDependsFlow.steps!.length = forceDependsFlow.steps!.length - 1;\n\t\tflow.steps\n\t\t\t.filter((step, index) => index !== 0)\n\t\t\t.forEach(step =>\n\t\t\t\tforceDependsFlow.steps!.push({\n\t\t\t\t\t...step,\n\t\t\t\t\torigin: {\n\t\t\t\t\t\tstory: storyName,\n\t\t\t\t\t\tflow: flow.name,\n\t\t\t\t\t\tstepIndex: step.stepIndex\n\t\t\t\t\t}\n\t\t\t\t} as Step)\n\t\t\t);\n\t\tmergeFlowInput(flow, forceDependsFlow);\n\t\tflow = forceDependsFlow;\n\t}\n\n\tconst startStep = flow.steps![0] as StartStep;\n\tif (startStep.type !== 'start') {\n\t\tconsole.info(\n\t\t\t(`Process[${processId}] Flow ${flowKey} has no start step, ignored.` as any).red\n\t\t);\n\t\treturn Promise.reject();\n\t}\n\tif (!startStep.url) {\n\t\tconsole.info(\n\t\t\t(`Process[${processId}] Flow ${flowKey} has no start url, ignored.` as any).red\n\t\t);\n\t\treturn Promise.reject();\n\t}\n\n\tconst emitter = new ReplayEmitter();\n\tlet replayer;\n\ttry {\n\t\treplayer = createReplayer({ emitter, logger, env }).initialize();\n\t} catch (e) {\n\t\tlogger.error(e);\n\t\treturn Promise.reject();\n\t}\n\n\tconst promise = new Promise<FlowResult>(resolve => {\n\t\thandleReplayStepEnd(emitter, { name: storyName } as Story, flow, () => {\n\t\t\tconst summary = replayer.current.getSummaryData();\n\t\t\ttimeLogger.timeEnd(flowKey);\n\t\t\tresolve({\n\t\t\t\treport: { ...summary, spent: timeSpent },\n\t\t\t\tcoverages: replayer.current.getCoverageData()\n\t\t\t});\n\t\t});\n\t});\n\temitter.send('launch-replay', { flow, index: 0, storyName });\n\treturn promise;\n};\n"]}